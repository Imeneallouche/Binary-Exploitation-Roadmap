# Calling Conventions

To be able to call functions, there needs to be an agreed-upon way to pass arguments. If a program is entirely self-contained in a binary, the compiler would be free to decide the calling convention. However in reality, shared libraries are used so that common code (e.g. libc) can be stored once and dynamically linked in to programs that need it, reducing program size.

In Linux binaries, there are really only two commonly used calling conventions:
```yaml
cdecl: for 32-bit binaries
SysV : for 64-bit binaries
```
<br>

# cdecl
The cdecl (which stands for C declaration) is a calling convention for the C programming language and is used by many C compilers for the x86 architecture.In cdecl:

```yaml
subroutine args: are passed on the stack.
Int values & memory adrs: are returned in the EAX register.
floating point values: in the ST0 x87 register.

Registers EAX,ECX,EDX: are caller-saved
The rest: are callee-saved.

- The x87 floating point registers ST0 to ST7 must be empty (popped or freed) when calling a new function
- ST1 to ST7 must be empty on exiting a function.
- ST0 must also be empty when not used for returning a value.
```

In the context of the C programming language, function arguments are pushed on the stack in the right-to-left order, i.e. the last argument is pushed first.

Consider the following C source code snippet:

```c
int callee(int, int, int);

int caller(void)
{
	return callee(1, 2, 3) + 5;
}
```
On x86, it might produce the following assembly code:
```asm
caller:
    ; make new call frame
    ; (some compilers may produce an 'enter' instruction instead)
    push    ebp       ; save old call frame
    mov     ebp, esp  ; initialize new call frame
    ; push call arguments, in reverse
    ; (some compilers may subtract the required space from the stack pointer,
    ; then write each argument directly, see below.
    ; The 'enter' instruction can also do something similar)
    ; sub esp, 12      : 'enter' instruction could do this for us
    ; mov [ebp-4], 3   : or mov [esp+8], 3
    ; mov [ebp-8], 2   : or mov [esp+4], 2
    ; mov [ebp-12], 1  : or mov [esp], 1
    push    3
    push    2
    push    1
    call    callee    ; call subroutine 'callee'
    add     esp, 12   ; remove call arguments from frame
    add     eax, 5    ; modify subroutine result
                      ; (eax is the return value of our callee,
                      ; so we don't have to move it into a local variable)
    ; restore old call frame
    ; (some compilers may produce a 'leave' instruction instead)
    mov     esp, ebp  ; most calling conventions dictate ebp be callee-saved,
                      ; i.e. it's preserved after calling the callee.
                      ; it therefore still points to the start of our stack frame.
                      ; we do need to make sure
                      ; callee doesn't modify (or restore) ebp, though,
                      ; so we need to make sure
                      ; it uses a calling convention which does this
    pop     ebp       ; restore old call frame
    ret               ; return
```

The caller cleans the stack after the function call returns.

The cdecl calling convention is usually the default calling convention for x86 C compilers, although many compilers provide options to automatically change the calling conventions used. To manually define a function to be cdecl, some support the following syntax:
```c
return_type __cdecl func_name();
```

<br>

# SysV
The calling convention of the System V AMD64 ABI is followed on Solaris, Linux, FreeBSD, macOS,[26] and is the de facto standard among Unix and Unix-like operating systems. 
For 64-bit binaries,the 6 function arguments are first passed in certain registers:

<table width='100%'>
  <tr>
    <td>Argument Type</td>
    <td colspan='10'>Registers</td>
  </tr>
    
  <tr>
    <td> <br> Integer/Pointer Arguments 1-6</td>
    <td colspan='10'> <br> RDI, RSI, RDX, RCX, R8, R9 <br>  </td>
  </tr>
    
  
   <tr>
    <td> <br> Floating Point Arguments 1-8 <br> </td>
    <td colspan='10'> <br> XMM0 - XMM7 <br> </td>
  </tr>
  
  
   <tr>
    <td> <br> Excess Arguments</td>
    <td colspan='10'> <br> Stack <br> </td>
  </tr>
  
  
   <tr>
    <td> <br> Static chain pointer</td>
    <td colspan='10'><br> R10 <br></td>
  </tr>  
</table>


then any leftover arguments are pushed onto the stack in reverse order, as in cdecl.

# Other Conventions
Any method of passing arguments could be used as long as the compiler is aware of what the convention is. As a result, there have been many calling conventions in the past that aren't used frequently anymore. See <a href="https://en.wikipedia.org/wiki/X86_calling_conventions"> Wikipedia </a> for a comprehensive list.

