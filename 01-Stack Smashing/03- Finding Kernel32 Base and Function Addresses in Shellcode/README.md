# Finding Kernel32 Base and Function Addresses in Shellcode

The purpose of this lab is to understand how shellcode finds kernel32 base address in memory of the process it's running in and then uses to find addresses of other functions that it requires in order to achieve its goal. 
In this lab I will write some assembly to find the kernel32 dll's base address, resolve **WinExec** function address in memory and call it to open **calc.exe**.


<br>


# Finding Kernel32 Base Address
It's well known that shellcode usually leverages the following chain of internal Windows OS memory structures in order to resolve the kernel32 base address which I am going to walk through in WinDBG:

```bash
TEB->PEB->Ldr->InMemoryOrderLoadList->currentProgram->ntdll->kernel32.BaseDll
```

One important thing to keep in mind is that kernel32.dll is always loaded into the same address for all the processes - regardless if you open a calc.exe, notepad.exe, or any other Windows process. Below shows my program for this lab on the left and another random program on the right - in both cases, the kernel32.dll (and ntdll...) got loaded into the same memory address:

![image](https://github.com/Imeneallouche/Binary-Exploitation-Roadmap/assets/89279264/ea7887aa-5f18-4bfd-acdc-b5bf54a38fa2)


Let's get back to the:
```bash
TEB->PEB->Ldr->InMemoryOrderLoadList->currentProgram->ntdll->kernel32.BaseDll
```
and go into these with more detail.

<br>

# Structures
The first important OS structure of the chain is called a Thread Environment Block (TEB) which contains information about the process's thread, including one member that is a pointer to another very important structure called Process Environment Block (PEB, offset 0x30) where information about the process itself (image path, commandline arguments, loaded modules and similar) is stored:

```yaml
dt _teb
```

![image](https://github.com/Imeneallouche/Binary-Exploitation-Roadmap/assets/89279264/ff0f8fc9-125d-4616-9368-477c1d58205b)


Inside the PEB structure, there is a member Ldr which points to a PEB_LDR_DATA structure (offset 0x00c):
```yaml
dt _peb
```

![image](https://github.com/Imeneallouche/Binary-Exploitation-Roadmap/assets/89279264/3a19767e-cedd-4d7d-b5a5-e6d91242e541)

PEB_LDR_DATA contains a pointer to InMemoryOrderModuleList (offset 0x14) that contains information about the modules that were loaded in the process:
```yaml
dt _PEB_LDR_DATA
```

![image](https://github.com/Imeneallouche/Binary-Exploitation-Roadmap/assets/89279264/4433a387-e412-4086-88c7-a039dca71587)
